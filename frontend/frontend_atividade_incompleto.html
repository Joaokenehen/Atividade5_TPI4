<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trabalho Completo: Upload, Cadastro e Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      :root {
        --card-bg: #1e293b;
        --card-border: 1px solid #334155;
        --muted: #94a3b8;
      }
      
      html, body { 
        height: 100%;
        background: #0f172a;
        font-family: 'Inter', sans-serif;
      }
      
      .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        gap: 2rem;
      }

      .card-module {
        max-width: 500px;
        margin: 0 auto;
        width: 100%;
      }

      .message-box {
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
      }

      .message-box.error {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
      }

      .message-box.success {
        background-color: #dcfce7;
        color: #15803d;
        border: 1px solid #bbf7d0;
      }

      .submit-btn {
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
        transition: background-color 0.2s;
      }
      
      .submit-btn:hover {
        background: #2563eb;
      }
      
      .logout-btn {
        background-color: #dc2626; 
      }
      .logout-btn:hover {
        background-color: #b91c1c;
      }

      .form-input {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
      }

      @media (min-width: 1024px) {
        .main-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">

      <div class="card-module" id="login-module">
        <header>
          <div class="brand">
            <h1 class="text-white text-2xl font-bold">Login</h1>
            <p class="text-gray-400">Entre com suas credenciais</p>
          </div>
        </header>

        <div class="card" style="background: var(--card-bg); border: var(--card-border); padding: 1.5rem; border-radius: 0.5rem;">
          <form id="loginForm" class="space-y-4">
            <div>
              <input type="text" id="username" name="username" 
                     class="form-input bg-gray-900 border-gray-700 text-white" 
                     placeholder="Nome de usuário" required>
            </div>
            <div>
              <input type="password" id="password" name="password" 
                     class="form-input bg-gray-900 border-gray-700 text-white" 
                     placeholder="Senha" required>
            </div>
            <button type="submit" class="submit-btn w-full">
              Entrar
            </button>
          </form>
          <div id="loginMessageBox" class="message-box" style="display: none;"></div>
        </div>
      </div>

      <div class="card-module" id="upload-module">
        <header>
          <div class="brand">
            <h1 class="text-white text-2xl font-bold">Upload de Imagens</h1>
            <p class="text-gray-400">Envie suas imagens (PNG, JPG)</p>
          </div>
        </header>

        <div class="card" style="background: var(--card-bg); border: var(--card-border); padding: 1.5rem; border-radius: 0.5rem;">
          <form id="uploadForm" class="space-y-4">
            <input type="file" id="fileInput" name="meusArquivos" multiple accept="image/png, image/jpeg" 
                   class="block w-full text-sm text-gray-400
                   file:mr-4 file:py-2 file:px-4
                   file:rounded-md file:border-0
                   file:text-sm file:font-semibold
                   file:bg-blue-500 file:text-white
                   hover:file:bg-blue-600">
            <button type="submit" class="submit-btn w-full">
              Enviar Arquivos
            </button>
          </form>
          <div id="messageBox" class="message-box" style="display: none;"></div>
        </div>
      </div>

      <div class="card-module" id="register-module">
        <header>
          <div class="brand">
            <h1 class="text-white text-2xl font-bold">Registro</h1>
            <p class="text-gray-400">Crie sua conta</p>
          </div>
        </header>

        <div class="card" style="background: var(--card-bg); border: var(--card-border); padding: 1.5rem; border-radius: 0.5rem;">
          <form id="registerForm" class="space-y-4">
            <input type="text" id="registerUsername" name="username" 
                   class="form-input bg-gray-900 border-gray-700 text-white" 
                   placeholder="Nome de usuário" required>
            <input type="email" id="registerEmail" name="email" 
                   class="form-input bg-gray-900 border-gray-700 text-white" 
                   placeholder="Email" required>
            <input type="password" id="registerPassword" name="password" 
                   class="form-input bg-gray-900 border-gray-700 text-white" 
                   placeholder="Senha" required>
            <button type="submit" class="submit-btn w-full">
              Registrar
            </button>
          </form>
          <div id="registerMessageBox" class="message-box" style="display: none;"></div>
        </div>
      </div>
      
      <div class="card-module" id="user-module" style="display: none;">
        <header>
          <div class="brand">
            <h1 class="text-white text-2xl font-bold">Painel do Usuário</h1>
            <p id="welcome-message" class="text-gray-400">Bem-vindo!</p>
          </div>
        </header>
        <div class="card" style="background: var(--card-bg); border: var(--card-border); padding: 1.5rem; border-radius: 0.5rem;">
          <button id="logoutButton" class="submit-btn logout-btn w-full">
            Sair (Logout)
          </button>
        </div>
      </div>

    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        const loginModule = document.getElementById('login-module');
        const registerModule = document.getElementById('register-module');
        const uploadModule = document.getElementById('upload-module');
        const userModule = document.getElementById('user-module');
        
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const uploadForm = document.getElementById('uploadForm');
        
        const logoutButton = document.getElementById('logoutButton');
        const welcomeMessage = document.getElementById('welcome-message');

        const loginMessageBox = document.getElementById('loginMessageBox');
        const registerMessageBox = document.getElementById('registerMessageBox');
        const uploadMessageBox = document.getElementById('messageBox');


        function atualizarUI() {
          const token = localStorage.getItem('token');
          const username = localStorage.getItem('username');
          
          uploadModule.style.display = 'block';

          if (token) {
            loginModule.style.display = 'none';
            registerModule.style.display = 'none';
            userModule.style.display = 'block';
            welcomeMessage.textContent = `Bem-vindo, ${username || 'Usuário'}!`;
          } else {
            loginModule.style.display = 'block';
            registerModule.style.display = 'block';
            userModule.style.display = 'none';
          }
          
          loginMessageBox.style.display = 'none';
          registerMessageBox.style.display = 'none';
          uploadMessageBox.style.display = 'none';
        }

        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value.trim();

          try {
            const response = await fetch('http://localhost:3000/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            loginMessageBox.style.display = 'block';
            
            if (response.ok) {
              loginMessageBox.className = 'message-box success';
              loginMessageBox.textContent = 'Login realizado com sucesso!';
              
              localStorage.setItem('token', data.token);
              localStorage.setItem('username', data.user.username);
              
              atualizarUI();
            } else {
              loginMessageBox.className = 'message-box error';
              loginMessageBox.textContent = data.error || 'Credenciais inválidas';
            }
          } catch (error) {
            loginMessageBox.className = 'message-box error';
            loginMessageBox.textContent = 'Erro ao conectar com o servidor';
            loginMessageBox.style.display = 'block';
          }
        });

        // --- Script de Upload (Envia a requisição e captura o erro) ---
       uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const files = document.getElementById('fileInput').files;
        const token = localStorage.getItem('token');
        const formData = new FormData();

        // 1. VALIDAÇÃO (Isto já funciona para você)
        if (files.length === 0) {
            uploadMessageBox.style.display = 'block';
            uploadMessageBox.className = 'message-box error';
            uploadMessageBox.textContent = 'Por favor, selecione pelo menos um arquivo.';
            return;
        }

        // Validação de login
        if (!token) {
            uploadMessageBox.style.display = 'block';
            uploadMessageBox.className = 'message-box error';
            uploadMessageBox.textContent = 'Acesso negado. Token não fornecido. Por favor, faça login primeiro.';
            return;
        }

        // Prepara os arquivos
        for (let i = 0; i < files.length; i++) {
            formData.append('meusArquivos', files[i]);
        }

        try {
            // 2. Tenta enviar para o servidor
            const response = await fetch('http://localhost:3000/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            // 3. VERIFICA SE A RESPOSTA NÃO FOI OK (ex: 401, 403, 500)
            if (!response.ok) {
                // O servidor respondeu com erro (ex: 401 - Não Autorizado)
                let errorMessage = 'Erro ao enviar. Tente fazer login novamente.'; // Mensagem padrão
                
                try {
                    // Tenta ler o JSON de erro que o server.js enviou
                    const data = await response.json();
                    if (data.error) {
                        errorMessage = data.error; // Ex: "Acesso negado. Token não fornecido."
                    }
                } catch (jsonError) {
                    // Se o servidor enviar um erro sem JSON, caímos aqui
                    console.error("Não foi possível ler o JSON da resposta de erro:", jsonError);
                }

                // 4. MOSTRA A MENSAGEM DE ERRO (EM VERMELHO) NO FRONTEND
                uploadMessageBox.textContent = errorMessage;
                uploadMessageBox.className = 'message-box error';
                uploadMessageBox.style.display = 'block';

                // 5. Se o erro for de autorização, desloga o usuário da UI
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    atualizarUI();
                }
                return; // Para a execução aqui
            }

            // 6. SE A RESPOSTA FOI OK (Sucesso 200)
            const data = await response.json();
            uploadMessageBox.textContent = data.message || 'Arquivos enviados com sucesso!';
            uploadMessageBox.className = 'message-box success';
            uploadMessageBox.style.display = 'block';
            uploadForm.reset();

        } catch (networkError) {
            // 7. Se o 'fetch' falhar (servidor offline, etc.)
            console.error("Erro de rede:", networkError);
            uploadMessageBox.textContent = 'Erro ao conectar com o servidor.';
            uploadMessageBox.className = 'message-box error';
            uploadMessageBox.style.display = 'block';
        }
    });

        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('registerUsername').value.trim();
          const email = document.getElementById('registerEmail').value.trim();
          const password = document.getElementById('registerPassword').value.trim();
          
          try {
            const response = await fetch('http://localhost:3000/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username, email, password })
            });

            const data = await response.json();
            registerMessageBox.style.display = 'block';
            
            if (response.ok) {
              registerMessageBox.className = 'message-box success';
              registerMessageBox.textContent = 'Registro realizado com sucesso! Faça o login.';
              registerForm.reset();
            } else {
              registerMessageBox.className = 'message-box error';
              registerMessageBox.textContent = data.error || 'Erro ao registrar';
            }
          } catch (error) {
            registerMessageBox.style.display = 'block';
            registerMessageBox.className = 'message-box error';
            registerMessageBox.textContent = 'Erro ao conectar com o servidor';
          }
        });
        
        logoutButton.addEventListener('click', () => {
          localStorage.removeItem('token');
          localStorage.removeItem('username');
          
          loginMessageBox.className = 'message-box success';
          loginMessageBox.textContent = 'Você saiu com sucesso.';
          loginMessageBox.style.display = 'block';

          atualizarUI();
        });


        atualizarUI();
      });
    </script>
  </body>
</html>